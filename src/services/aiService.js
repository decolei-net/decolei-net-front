// Configura√ß√µes das APIs
const AI_CONFIGS = {
  gemini: {
    apiUrl:
      'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent',
    model: 'gemini-2.0-flash',
  },
  // outras APIs aqui
};

class AIService {
  constructor() {
    this.provider = 'gemini'; // Configur√°vel via .env
    this.apiKey = import.meta.env.VITE_GEMINI_API_KEY || 'AIzaSyAfK6cwBaI5THD7lbKgS8rOZKtmKjbKi-g';
    this.cache = new Map(); // Cache para respostas comuns
    this.rateLimiter = {
      requests: [],
      maxRequests: 10,
      timeWindow: 60000, // 1 minuto
    };
  }

  // Rate limiting
  checkRateLimit() {
    const now = Date.now();
    this.rateLimiter.requests = this.rateLimiter.requests.filter(
      (time) => now - time < this.rateLimiter.timeWindow,
    );

    if (this.rateLimiter.requests.length >= this.rateLimiter.maxRequests) {
      throw new Error('RATE_LIMIT_EXCEEDED');
    }

    this.rateLimiter.requests.push(now);
  }

  // Sistema de cache
  getCacheKey(message, context = []) {
    const contextString = context
      .slice(-3)
      .map((msg) => msg.text)
      .join('|');
    return `${message.toLowerCase().trim()}|${contextString}`;
  }

  getCachedResponse(key) {
    const cached = this.cache.get(key);
    if (cached && Date.now() - cached.timestamp < 3600000) {
      // 1 hora
      return cached.response;
    }
    return null;
  }

  setCachedResponse(key, response) {
    this.cache.set(key, {
      response,
      timestamp: Date.now(),
    });
  }

  // M√©todo principal para enviar mensagem para a IA
  async sendMessage(userMessage, conversationHistory = [], pageContext = null) {
    try {
      // Rate limiting
      this.checkRateLimit();

      // Verificar cache primeiro
      const cacheKey = this.getCacheKey(userMessage, conversationHistory);
      const cachedResponse = this.getCachedResponse(cacheKey);

      if (cachedResponse) {
        return cachedResponse;
      }

      // Verificar se a chave de API est√° configurada
      if (!this.apiKey) {
        console.warn(`Chave de API n√£o configurada para ${this.provider}. Usando fallback.`);
        return this.getFallbackResponse(userMessage, pageContext);
      }

      const response = await this.sendToGemini(userMessage, conversationHistory, pageContext);

      // Cachear a resposta
      this.setCachedResponse(cacheKey, response);

      return response;
    } catch (error) {
      console.error(`Erro na API de IA (${this.provider}):`, error.message);

      // Mensagens de erro mais espec√≠ficas
      if (error.message === 'RATE_LIMIT_EXCEEDED') {
        return '‚è≥ Calma a√≠! Voc√™ est√° enviando muitas mensagens. Aguarde um minutinho antes de continuar nossa conversa.';
      } else if (error.message.includes('401')) {
        console.error('‚ùå Chave de API inv√°lida. Verifique sua configura√ß√£o no arquivo .env');
      } else if (error.message.includes('429')) {
        console.error('‚ö†Ô∏è Limite de requisi√ß√µes excedido. Tente novamente em alguns minutos.');
        return '‚è≥ Estou um pouco sobrecarregado no momento. Que tal tentar novamente em alguns minutos?';
      } else if (error.message.includes('403')) {
        console.error('üö´ Acesso negado. Verifique as permiss√µes da sua chave de API.');
      }

      // SEMPRE retorna uma resposta de fallback quando h√° erro
      return this.getFallbackResponse(userMessage, pageContext);
    }
  }

  async sendToGemini(userMessage, conversationHistory, pageContext) {
    if (!this.apiKey) {
      throw new Error('API Key do Gemini n√£o configurada');
    }

    // Contexto adicional baseado na p√°gina atual
    const contextualInfo = pageContext ? this.getPageContext(pageContext) : '';

    const systemContext = `Voc√™ √© C√©lio, assistente virtual da Decolei.net, uma ag√™ncia de turismo brasileira moderna.

INFORMA√á√ïES DA EMPRESA:
- Ag√™ncia de turismo com foco em experi√™ncia digital, uma api que n√£o esta no ar
- Website responsivo (mobile-first)
- Sistema completo de reservas online
- Desenvolvido por: Leonardo Amyntas Machado de Freitas Filho, Eduardo da Silva Bezerra, Arthur Henrique Martins Santos, Kamylla Reis de Ara√∫jo Silva e Le√¥nidas Dantas de Castro Netto
- Turma Decola 6 - 2025, Trilha Prof. Celio de Souza

CONTATO E SUPORTE:
- Email: decoleinet@gmail.com
- P√°gina de Suporte: Acesse atrav√©s do rodap√© do site ou digite "suporte" no chat
- Desenvolvedores: Dispon√≠vel no rodap√© da p√°gina principal

PROCESSO DE RESERVA (FLUXO COMPLETO):
1. Cliente navega na HOME e v√™ pacotes em destaque
2. Clica no pacote desejado para ver detalhes completos
3. Clica em "Reservar e Pagar" na p√°gina de detalhes
4. √â redirecionado para tela de ADICIONAR VIAJANTES, ele adiciona se quiser e o usuario ja esta incluso, n √£o precisa ser adicionado
5. Depois vai para PAGAMENTO com as op√ß√µes dispon√≠veis

PRINCIPAIS FUNCIONALIDADES:
‚Ä¢ PACOTES: Busca por destino, pre√ßo, datas | Detalhes completos | Sistema de avalia√ß√µes
‚Ä¢ RESERVAS: Adicionar viajantes (titular + acompanhantes) | C√°lculo autom√°tico de valores
‚Ä¢ PAGAMENTOS: Cart√£o (aprova√ß√£o instant√¢nea) | PIX (instant√¢neo) | Boleto (~1min para confirma√ß√£o)
‚Ä¢ CONTA CLIENTE: Hist√≥rico de reservas | Status de pagamentos | Avalia√ß√µes p√≥s-viagem
‚Ä¢ AVALIA√á√ÉO: O cliente pode avaliar um pacote na aba de perfil ap√≥s o termino dele(data de fim do pacote/reserva)
‚Ä¢ SUPORTE: Busca por nome/email/reserva | Recupera√ß√£o de senha por email

${contextualInfo}

COMO AJUDAR:
- Apresente-se como Celio quando cumprimentado
- Quando perguntado sobre seu nome, explique que √© uma homenagem ao professor Celio de Souza da Impacta em parceirai com a Avanade, respons√°vel pela trilha: REACT.JS - C# - ASP.NET do programa Decola tech 6 2025 da avanade
- Seja prestativo e objetivo (max 200 palavras)
- Foque em solu√ß√µes pr√°ticas
- Use informa√ß√µes espec√≠ficas da Decolei.net
- Direcione problemas t√©cnicos ao suporte humano (decoleinet@gmail.com)
- Sempre em portugu√™s brasileiro
- Para d√∫vidas sobre desenvolvedores, mencione que est√£o listados no rodap√© (nomes completos)`;

    const prompt = `${systemContext}

Hist√≥rico da conversa:
${conversationHistory
  .slice(-5)
  .map((msg) => `${msg.isBot ? 'Assistente' : 'Cliente'}: ${msg.text}`)
  .join('\n')}

Cliente: ${userMessage}

C√©lio (Assistente Decolei.net):`;

    const response = await fetch(`${AI_CONFIGS.gemini.apiUrl}?key=${this.apiKey}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        contents: [
          {
            parts: [
              {
                text: prompt,
              },
            ],
          },
        ],
        generationConfig: {
          temperature: 0.7,
          topK: 40,
          topP: 0.95,
          maxOutputTokens: 300,
        },
        safetySettings: [
          {
            category: 'HARM_CATEGORY_HARASSMENT',
            threshold: 'BLOCK_MEDIUM_AND_ABOVE',
          },
        ],
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Erro da API Gemini:', errorText);
      throw new Error(`Gemini API error: ${response.status} - ${errorText}`);
    }

    const data = await response.json();

    if (!data.candidates || data.candidates.length === 0) {
      throw new Error('Nenhuma resposta gerada pelo Gemini');
    }

    return (
      data.candidates[0]?.content?.parts[0]?.text ||
      this.getFallbackResponse(userMessage, pageContext)
    );
  }

  // Contexto baseado na p√°gina atual
  getPageContext(pathname) {
    const contexts = {
      '/': 'CONTEXTO ATUAL: Usu√°rio est√° na p√°gina inicial vendo pacotes em destaque.',
      '/pacotes': 'CONTEXTO ATUAL: Usu√°rio est√° navegando pelos pacotes dispon√≠veis.',
      '/reserva': 'CONTEXTO ATUAL: Usu√°rio est√° no processo de reserva.',
      '/pagamento': 'CONTEXTO ATUAL: Usu√°rio est√° na p√°gina de pagamento.',
      '/perfil': 'CONTEXTO ATUAL: Usu√°rio est√° em sua √°rea pessoal/perfil.',
      '/admin': 'CONTEXTO ATUAL: Usu√°rio est√° na √°rea administrativa.',
      '/dashboard': 'CONTEXTO ATUAL: Usu√°rio est√° no dashboard.',
    };

    return contexts[pathname] || '';
  }

  // M√©todo de fallback quando a IA n√£o est√° dispon√≠vel
  getFallbackResponse(userMessage, pageContext = null) {
    const message = userMessage.toLowerCase();

    // Contexto da p√°gina atual para respostas mais espec√≠ficas
    const contextualHelp = pageContext ? this.getContextualHelp(pageContext) : '';

    // Verificar se a mensagem cont√©m sauda√ß√£o + pergunta sobre reserva
    const temSaudacao =
      message.includes('bom dia') ||
      message.includes('boa tarde') ||
      message.includes('boa noite') ||
      message.includes('ol√°') ||
      message.includes('oi') ||
      message.includes('hello');
    const perguntaReserva =
      message.includes('reserva') || message.includes('reservar') || message.includes('booking');

    if (temSaudacao && perguntaReserva) {
      return `Ol√°! Sou C√©lio, assistente virtual da Decolei.net! üëã

Para fazer uma reserva √© muito simples:

üéØ PASSO A PASSO:
1Ô∏è‚É£ Navegue pela p√°gina inicial (HOME)
2Ô∏è‚É£ Clique no pacote que mais te interessar
3Ô∏è‚É£ Na p√°gina de detalhes, clique "Reservar e Pagar"
4Ô∏è‚É£ Adicione viajantes (voc√™ j√° est√° inclu√≠do!)
5Ô∏è‚É£ Escolha sua forma de pagamento

üí≥ Formas de pagamento:
‚Ä¢ Cart√£o: Aprova√ß√£o instant√¢nea
‚Ä¢ PIX: Pagamento instant√¢neo
‚Ä¢ Boleto: Confirma√ß√£o em ~1 minuto

${contextualHelp}

Precisa de ajuda com algum passo espec√≠fico?`;
    }

    // Respostas categorizadas e melhoradas
    if (this.isGreeting(message)) {
      return `Ol√°! Sou C√©lio, assistente virtual da Decolei.net! üëã

Como posso te ajudar hoje? Posso auxiliar com:
‚Ä¢ üéí Informa√ß√µes sobre pacotes
‚Ä¢ üìù Processo de reservas
‚Ä¢ üí≥ Formas de pagamento
‚Ä¢ üë§ Conta e hist√≥rico
‚Ä¢ üÜò Suporte t√©cnico

${contextualHelp}`;
    }

    if (this.isAboutReservation(message)) {
      return `üìã Como fazer uma reserva na Decolei.net:

FLUXO COMPLETO:
1Ô∏è‚É£ Navegue pelos pacotes na p√°gina inicial
2Ô∏è‚É£ Clique no pacote desejado para ver detalhes
3Ô∏è‚É£ Clique em "Reservar e Pagar"
4Ô∏è‚É£ Adicione viajantes (voc√™ j√° est√° inclu√≠do!)
5Ô∏è‚É£ Escolha a forma de pagamento

${contextualHelp}

Alguma d√∫vida espec√≠fica sobre este processo?`;
    }

    // Continua com as outras categorias...
    if (this.isAboutPayment(message)) {
      return this.getPaymentInfo();
    }

    if (this.isAboutPackages(message)) {
      return this.getPackageInfo();
    }

    if (this.isAboutEvaluation(message)) {
      return this.getEvaluationInfo();
    }

    if (this.isAboutAccount(message)) {
      return this.getAccountInfo();
    }

    if (this.isAboutSupport(message)) {
      return this.getSupportInfo();
    }

    if (this.isAboutIdentity(message)) {
      return this.getIdentityInfo();
    }

    if (this.isAboutCompany(message)) {
      return this.getCompanyInfo();
    }

    if (this.isAboutPrice(message)) {
      return this.getPriceInfo();
    }

    if (this.isAboutTravelers(message)) {
      return this.getTravelersInfo();
    }

    if (this.isGoodbye(message)) {
      return `Por nada! Foi um prazer ajudar! üòä

Se precisar de mais alguma coisa sobre a Decolei.net, estarei aqui.
‚úàÔ∏è Boa viagem e at√© a pr√≥xima!`;
    }

    // Resposta padr√£o melhorada
    return `ü§ñ Ops! Estou com dificuldades t√©cnicas moment√¢neas...

Mas posso ajudar com:
‚Ä¢ üéí Pacotes de turismo e destinos
‚Ä¢ üìù Processo de reservas passo a passo
‚Ä¢ üí≥ Formas de pagamento (Cart√£o, PIX, Boleto)
‚Ä¢ ‚≠ê Sistema de avalia√ß√µes
‚Ä¢ üë§ Conta e hist√≥rico de reservas
‚Ä¢ üÜò Contato e suporte t√©cnico

Para quest√µes espec√≠ficas: decoleinet@gmail.com

${contextualHelp}

üí¨ Reformule sua pergunta que tentarei ajudar melhor!`;
  }

  // M√©todos auxiliares para categoriza√ß√£o
  isGreeting(message) {
    return /\b(ol√°|oi|hello|bom dia|boa tarde|boa noite|hey)\b/.test(message);
  }

  isAboutReservation(message) {
    return /\b(reserva|reservar|booking|agendar)\b/.test(message);
  }

  isAboutPayment(message) {
    return /\b(pagamento|pagar|cart√£o|pix|boleto|forma.*pag)\b/.test(message);
  }

  isAboutPackages(message) {
    return /\b(pacote|viagem|destino|turismo|trip)\b/.test(message);
  }

  isAboutEvaluation(message) {
    return /\b(avalia√ß√£o|avaliar|review|coment√°rio|estrela)\b/.test(message);
  }

  isAboutAccount(message) {
    return /\b(conta|perfil|hist√≥rico|minhas reservas|login)\b/.test(message);
  }

  isAboutSupport(message) {
    return /\b(suporte|ajuda|problema|d√∫vida|erro)\b/.test(message);
  }

  isAboutIdentity(message) {
    return /\b(quem|nome|c√©lio|celio|voc√™|seu nome)\b/.test(message);
  }

  isAboutCompany(message) {
    return /\b(empresa|decolei|sobre|quem somos|hist√≥ria)\b/.test(message);
  }

  isAboutPrice(message) {
    return /\b(pre√ßo|valor|custo|quanto|dinheiro)\b/.test(message);
  }

  isAboutTravelers(message) {
    return /\b(viajante|acompanhante|adicionar pessoa|grupo)\b/.test(message);
  }

  isGoodbye(message) {
    return /\b(obrigado|valeu|tchau|at√© logo|bye|thanks)\b/.test(message);
  }

  // M√©todos para respostas espec√≠ficas
  getPaymentInfo() {
    return `üí≥ Formas de pagamento na Decolei.net:

‚Ä¢ Cart√£o: Aprova√ß√£o instant√¢nea ‚ö°
‚Ä¢ PIX: Pagamento instant√¢neo üöÄ
‚Ä¢ Boleto: Confirma√ß√£o em ~1 minuto ‚è±Ô∏è

Vantagens:
‚úÖ Processo seguro e transparente
‚úÖ Sem taxas ocultas
‚úÖ Confirma√ß√£o autom√°tica

Qual m√©todo voc√™ gostaria de saber mais detalhes?`;
  }

  getPackageInfo() {
    return `üéí Pacotes na Decolei.net:

Funcionalidades:
üîç Busca por destino, pre√ßo e datas
üì∏ Detalhes completos com fotos
‚≠ê Sistema de avalia√ß√µes de clientes
üí∞ Pre√ßos transparentes

Como encontrar:
‚Ä¢ Navegue pela p√°gina inicial
‚Ä¢ Use nossos filtros inteligentes
‚Ä¢ Veja pacotes em destaque

Procurando algum destino espec√≠fico?`;
  }

  getEvaluationInfo() {
    return `‚≠ê Sistema de Avalia√ß√µes:

Como funciona:
üìÖ Ap√≥s o t√©rmino da viagem
üë§ Acesse seu perfil para avaliar
üí¨ Compartilhe sua experi√™ncia
üëÄ Veja avalia√ß√µes de outros clientes

Benef√≠cios:
‚úÖ Ajuda outros viajantes
‚úÖ Melhora nossos servi√ßos
‚úÖ Transpar√™ncia total

Sua opini√£o √© muito importante para n√≥s! üôè`;
  }

  getAccountInfo() {
    return `üë§ Sua conta Decolei.net:

Acesso completo a:
üìã Hist√≥rico de reservas
üí≥ Status de pagamentos
‚≠ê Suas avalia√ß√µes p√≥s-viagem
‚öôÔ∏è Gerenciamento de dados pessoais

Para acessar:
üîê Fa√ßa login na sua conta

Precisa de ajuda com login ou recupera√ß√£o de senha?`;
  }

  getSupportInfo() {
    return `üÜò Suporte Decolei.net:

Canais dispon√≠veis:
üìß Email: decoleinet@gmail.com
üåê P√°gina de Suporte: Acesse pelo rodap√©
üë®‚Äçüíª Desenvolvedores: Informa√ß√µes no rodap√©

Para que posso ajudar agora:
‚Ä¢ Informa√ß√µes gerais sobre reservas
‚Ä¢ D√∫vidas sobre pacotes
‚Ä¢ Orienta√ß√µes sobre o site

Para quest√µes t√©cnicas espec√≠ficas, recomendo o email de suporte!`;
  }

  getIdentityInfo() {
    return `ü§ñ Sou C√©lio, assistente virtual da Decolei.net!

Sobre meu nome:
üë®‚Äçüè´ Homenagem ao Professor C√©lio de Souza da Impacta
ü§ù Em parceria com a Avanade
üéØ Respons√°vel pela trilha REACT.JS - C# - ASP.NET
üìö Programa Decola Tech 6 2025

Desenvolvido por:
Leonardo Amyntas, Eduardo Bezerra, Arthur Martins, Kamylla Reis e Le√¥nidas Dantas

Como posso te ajudar hoje? üòä`;
  }

  getCompanyInfo() {
    return `üè¢ A Decolei.net:

Sobre n√≥s:
‚úàÔ∏è Ag√™ncia de turismo brasileira moderna
üì± Foco em experi√™ncia digital
üì± Website responsivo (mobile-first)
üîß Sistema completo de reservas online
‚≠ê Sistema de avalia√ß√µes p√≥s-viagem

Desenvolvida pela:
üéì Turma Decola 6 - 2025
üë®‚Äçüè´ Trilha do Prof. C√©lio de Souza

Como posso ajudar voc√™ a planejar sua pr√≥xima viagem? üåé`;
  }

  getPriceInfo() {
    return `üí∞ Pre√ßos na Decolei.net:

Nossos diferenciais:
‚úÖ Pre√ßos transparentes sem taxas ocultas
üßÆ C√°lculo autom√°tico por viajante
üí∏ Op√ß√µes para todos os or√ßamentos
üéâ Promo√ß√µes especiais em pacotes selecionados

Onde ver:
üì± Navegue pelos pacotes
üîç Use nossos filtros de pre√ßo
üíé Confira ofertas especiais

Procurando algo dentro de um or√ßamento espec√≠fico?`;
  }

  getTravelersInfo() {
    return `üë• Adicionando viajantes:

Como funciona:
‚úÖ Voc√™ (titular) j√° est√° inclu√≠do automaticamente
‚ûï Adicione quantos acompanhantes precisar
üìù Campos individuais para cada pessoa
üí∞ Valor calculado automaticamente

Super simples e intuitivo!

Alguma d√∫vida sobre como adicionar acompanhantes?`;
  }

  getContextualHelp(pathname) {
    const helps = {
      '/': '\nüí° Dica: Voc√™ est√° na p√°gina inicial! Explore os pacotes em destaque abaixo.',
      '/pacotes': '\nüí° Dica: Use os filtros para encontrar o pacote perfeito para voc√™!',
      '/reserva': '\nüí° Dica: Voc√™ est√° no processo de reserva. Siga os passos para finalizar!',
      '/pagamento': '\nüí° Dica: Escolha sua forma de pagamento preferida para finalizar.',
      '/perfil': '\nüí° Dica: Aqui voc√™ pode ver seu hist√≥rico e deixar avalia√ß√µes.',
      '/admin': '\nüí° Dica: √Årea administrativa - gerencie pacotes e usu√°rios.',
      '/dashboard': '\nüí° Dica: Acompanhe as m√©tricas e estat√≠sticas importantes.',
    };

    return helps[pathname] || '';
  }

  // M√©todo para configurar o provedor de IA
  setProvider(provider, apiKey) {
    this.provider = provider;
    this.apiKey = apiKey;
  }
}

export default new AIService();
